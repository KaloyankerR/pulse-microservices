_format_version: "3.0"

# Kong declarative configuration for Pulse microservices
# This file configures Kong to act as an API Gateway for all services

services:
  # User Service (Node.js)
  - name: user-service
    url: http://pulse-user-service:8080
    routes:
      - name: user-service-auth
        paths:
          - /api/v1/auth
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
      - name: user-service-users
        paths:
          - /api/v1/users
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
      - name: user-service-admin
        paths:
          - /api/v1/admin
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
      - name: user-service-health
        paths:
          - /health
        strip_path: false
        methods:
          - GET
    plugins:
      - name: cors
        config:
          origins:
            - "http://localhost:3000"
            - "http://localhost:3001"
            - "https://your-frontend-domain.com"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Auth-Token
            - Authorization
          exposed_headers:
            - X-Auth-Token
          credentials: true
          max_age: 3600
          preflight_continue: false
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local
      - name: request-size-limiting
        config:
          allowed_payload_size: 10

  # Auth Service (Java Spring Boot) - DISABLED
  # - name: auth-service
  #   url: http://auth-service:8080
  #   routes:
  #     - name: auth-service-routes
  #       paths:
  #         - /api/auth
  #       strip_path: false
  #       methods:
  #         - GET
  #         - POST
  #         - PUT
  #         - DELETE
  #         - OPTIONS
  #   plugins:
  #     - name: cors
  #       config:
  #         origins:
  #           - "http://localhost:3000"
  #           - "http://localhost:3001"
  #           - "https://your-frontend-domain.com"
  #         methods:
  #           - GET
  #           - POST
  #           - PUT
  #           - DELETE
  #           - OPTIONS
  #         headers:
  #           - Accept
  #           - Accept-Version
  #           - Content-Length
  #           - Content-MD5
  #           - Content-Type
  #           - Date
  #           - X-Auth-Token
  #           - Authorization
  #         exposed_headers:
  #           - X-Auth-Token
  #         credentials: true
  #         max_age: 3600
  #         preflight_continue: false
  #     - name: rate-limiting
  #       config:
  #         minute: 100
  #         hour: 1000
  #         policy: local

  # Tweet Service (Java Spring Boot) - DISABLED
  # - name: tweet-service
  #   url: http://tweet-service:8081
  #   routes:
  #     - name: tweet-service-routes
  #       paths:
  #         - /api/tweets
  #       strip_path: false
  #       methods:
  #         - GET
  #         - POST
  #         - PUT
  #         - DELETE
  #         - OPTIONS
  #   plugins:
  #     - name: cors
  #       config:
  #         origins:
  #           - "http://localhost:3000"
  #           - "http://localhost:3001"
  #           - "https://your-frontend-domain.com"
  #         methods:
  #           - GET
  #           - POST
  #           - PUT
  #           - DELETE
  #           - OPTIONS
  #         headers:
  #           - Accept
  #           - Accept-Version
  #           - Content-Length
  #           - Content-MD5
  #           - Content-Type
  #           - Date
  #           - X-Auth-Token
  #           - Authorization
  #         exposed_headers:
  #           - X-Auth-Token
  #         credentials: true
  #         max_age: 3600
  #         preflight_continue: false
  #     - name: rate-limiting
  #       config:
  #         minute: 100
  #         hour: 1000
  #         policy: local
  #     - name: jwt
  #       config:
  #         secret_is_base64: false
  #         run_on_preflight: true
  #         uri_param_names:
  #           - jwt
  #         cookie_names:
  #           - jwt
  #         header_names:
  #           - Authorization
  #         claims_to_verify:
  #           - exp
  #         anonymous: null
  #         key_claim_name: iss

# Global plugins (applied to all services)
plugins:
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true
  - name: correlation-id
    config:
      header_name: Kong-Request-ID
      generator: uuid
      echo_downstream: true

# Consumers for JWT authentication
consumers:
  - username: pulse-frontend
    custom_id: frontend-app
    jwt_secrets:
      - key: pulse-jwt-key
        secret: mySecretKey123456789012345678901234567890
        algorithm: HS256

# Global configuration
upstreams: []
targets: []
