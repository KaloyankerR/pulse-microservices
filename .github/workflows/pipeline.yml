name: Microservices Pipeline

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*.*.*'
      - '*-service-v*.*.*'
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (or "all" for all services)'
        required: true
        type: choice
        options:
          - all
          - user-service
          - auth-service
          - social-service
          - notification-service
          - messaging-service
          - post-service
          - event-service
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'staging'

# Prevent multiple workflow runs from running concurrently
# This will cancel in-progress runs when new ones are triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # ============================================================================
  # STAGE 0: DETECT CHANGES - Determine which services need to run
  # ============================================================================
  
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.services }}
      user-service: ${{ steps.filter.outputs.user-service }}
      auth-service: ${{ steps.filter.outputs.auth-service }}
      social-service: ${{ steps.filter.outputs.social-service }}
      notification-service: ${{ steps.filter.outputs.notification-service }}
      messaging-service: ${{ steps.filter.outputs.messaging-service }}
      post-service: ${{ steps.filter.outputs.post-service }}
      event-service: ${{ steps.filter.outputs.event-service }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect service changes
        id: filter
        run: |
          # For manual dispatch or tags, run all services
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "ðŸŽ¯ Manual trigger or tag detected - running all services"
            echo "services=[\"user-service\",\"auth-service\",\"social-service\",\"notification-service\",\"messaging-service\",\"post-service\",\"event-service\"]" >> $GITHUB_OUTPUT
            echo "user-service=true" >> $GITHUB_OUTPUT
            echo "auth-service=true" >> $GITHUB_OUTPUT
            echo "social-service=true" >> $GITHUB_OUTPUT
            echo "notification-service=true" >> $GITHUB_OUTPUT
            echo "messaging-service=true" >> $GITHUB_OUTPUT
            echo "post-service=true" >> $GITHUB_OUTPUT
            echo "event-service=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For PRs and pushes, detect changes
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            # For pushes, compare with previous commit
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi
          
          echo "ðŸ” Comparing $BASE_SHA...$HEAD_SHA"
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          
          echo "ðŸ“ Changed files:"
          echo "$CHANGED_FILES"
          
          # Check each service
          SERVICES=()
          
          # Check for root-level changes that affect all services
          ROOT_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^(docker-compose|\.github|Makefile|config/)' || true)
          if [[ -n "$ROOT_CHANGES" ]]; then
            echo "ðŸŒ Root-level changes detected - running all services"
            echo "services=[\"user-service\",\"auth-service\",\"social-service\",\"notification-service\",\"messaging-service\",\"post-service\",\"event-service\"]" >> $GITHUB_OUTPUT
            echo "user-service=true" >> $GITHUB_OUTPUT
            echo "auth-service=true" >> $GITHUB_OUTPUT
            echo "social-service=true" >> $GITHUB_OUTPUT
            echo "notification-service=true" >> $GITHUB_OUTPUT
            echo "messaging-service=true" >> $GITHUB_OUTPUT
            echo "post-service=true" >> $GITHUB_OUTPUT
            echo "event-service=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check individual services
          if echo "$CHANGED_FILES" | grep -q "^user-service/"; then
            echo "âœ… user-service changed"
            SERVICES+=("user-service")
            echo "user-service=true" >> $GITHUB_OUTPUT
          else
            echo "user-service=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^auth-service/"; then
            echo "âœ… auth-service changed"
            SERVICES+=("auth-service")
            echo "auth-service=true" >> $GITHUB_OUTPUT
          else
            echo "auth-service=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^social-service/"; then
            echo "âœ… social-service changed"
            SERVICES+=("social-service")
            echo "social-service=true" >> $GITHUB_OUTPUT
          else
            echo "social-service=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^notification-service/"; then
            echo "âœ… notification-service changed"
            SERVICES+=("notification-service")
            echo "notification-service=true" >> $GITHUB_OUTPUT
          else
            echo "notification-service=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^messaging-service/"; then
            echo "âœ… messaging-service changed"
            SERVICES+=("messaging-service")
            echo "messaging-service=true" >> $GITHUB_OUTPUT
          else
            echo "messaging-service=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^post-service/"; then
            echo "âœ… post-service changed"
            SERVICES+=("post-service")
            echo "post-service=true" >> $GITHUB_OUTPUT
          else
            echo "post-service=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^event-service/"; then
            echo "âœ… event-service changed"
            SERVICES+=("event-service")
            echo "event-service=true" >> $GITHUB_OUTPUT
          else
            echo "event-service=false" >> $GITHUB_OUTPUT
          fi
          
          # If no services changed, run all (safety fallback)
          if [ ${#SERVICES[@]} -eq 0 ]; then
            echo "âš ï¸ No service changes detected - running all services as fallback"
            echo "services=[\"user-service\",\"auth-service\",\"social-service\",\"notification-service\",\"messaging-service\",\"post-service\",\"event-service\"]" >> $GITHUB_OUTPUT
          else
            # Convert array to JSON
            SERVICES_JSON=$(printf '%s\n' "${SERVICES[@]}" | jq -R . | jq -s -c .)
            echo "services=$SERVICES_JSON" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Services to run: $SERVICES_JSON"
          fi

  # ============================================================================
  # STAGE 1: BUILD - Build all microservices
  # ============================================================================
  
  build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.services != '[]'
    
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Node.js services (user-service, auth-service, social-service, notification-service)
      - name: Setup Node.js
        if: matrix.service == 'user-service' || matrix.service == 'auth-service' || matrix.service == 'social-service' || matrix.service == 'notification-service'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.service }}/package-lock.json
      
      - name: Install Node dependencies
        if: matrix.service == 'user-service' || matrix.service == 'auth-service' || matrix.service == 'social-service' || matrix.service == 'notification-service'
        working-directory: ./${{ matrix.service }}
        run: npm ci
      
      - name: Generate Prisma Client
        if: matrix.service == 'user-service' || matrix.service == 'auth-service' || matrix.service == 'social-service'
        working-directory: ./${{ matrix.service }}
        run: npm run db:generate
      
      # Go services (messaging-service, post-service, event-service)
      - name: Setup Go
        if: matrix.service == 'messaging-service' || matrix.service == 'post-service' || matrix.service == 'event-service'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: ${{ matrix.service }}/go.sum
      
      - name: Build Go service
        if: matrix.service == 'messaging-service' || matrix.service == 'post-service' || matrix.service == 'event-service'
        working-directory: ./${{ matrix.service }}
        run: |
          go mod download
          go mod verify
          go build -v ./...
      
      - name: Build summary
        run: |
          echo "âœ… ${{ matrix.service }} - Build completed successfully"

  # ============================================================================
  # STAGE 2: TEST - Run tests after successful build
  # ============================================================================
  
  test:
    name: Test ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.services != '[]'
    
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      rabbitmq:
        image: rabbitmq:3-management-alpine
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5672:5672
          - 15672:15672
      
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: pulse_user
          MONGO_INITDB_ROOT_PASSWORD: pulse_user
          MONGO_INITDB_DATABASE: pulse_notifications
        options: >-
          --health-cmd "mongosh --eval \"db.adminCommand('ping')\""
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Node.js services (user-service, auth-service, social-service, notification-service)
      - name: Setup Node.js
        if: matrix.service == 'user-service' || matrix.service == 'auth-service' || matrix.service == 'social-service' || matrix.service == 'notification-service'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.service }}/package-lock.json
      
      - name: Install Node dependencies
        if: matrix.service == 'user-service' || matrix.service == 'auth-service' || matrix.service == 'social-service' || matrix.service == 'notification-service'
        working-directory: ./${{ matrix.service }}
        run: npm ci
      
      - name: Generate Prisma Client
        if: matrix.service == 'user-service' || matrix.service == 'auth-service' || matrix.service == 'social-service'
        working-directory: ./${{ matrix.service }}
        run: npm run db:generate
      
      - name: Run Node tests
        if: matrix.service == 'user-service' || matrix.service == 'auth-service' || matrix.service == 'social-service' || matrix.service == 'notification-service'
        working-directory: ./${{ matrix.service }}
        run: npm test
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
          MONGODB_URI: mongodb://pulse_user:pulse_user@localhost:27017/pulse_notifications
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672/
          JWT_SECRET: test-secret-key-for-ci
      
      # Go services (messaging-service, post-service, event-service)
      - name: Setup Go
        if: matrix.service == 'messaging-service' || matrix.service == 'post-service' || matrix.service == 'event-service'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: ${{ matrix.service }}/go.sum
      
      - name: Install Go dependencies
        if: matrix.service == 'messaging-service' || matrix.service == 'post-service' || matrix.service == 'event-service'
        working-directory: ./${{ matrix.service }}
        run: |
          go mod download
          go mod verify
      
      - name: Run Go tests
        if: matrix.service == 'messaging-service' || matrix.service == 'post-service' || matrix.service == 'event-service'
        working-directory: ./${{ matrix.service }}
        run: go test ./... -v
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/postgres?sslmode=disable
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672/
          JWT_SECRET: test-secret-key-for-ci
      
      - name: Test summary
        run: |
          echo "âœ… ${{ matrix.service }} - Tests passed"

  # ============================================================================
  # STAGE 3: DEPLOY - Build and push Docker images to registry
  # ============================================================================
  
  deploy:
    name: Deploy ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    # Only deploy for: push to main, tags, or manual dispatch
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/tags/')
    
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        run: |
          SERVICE="${{ matrix.service }}"
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/pulse-${SERVICE}"
          
          # Determine version, tags, and environment
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              # Full version tag (e.g., v1.0.0)
              VERSION="${TAG#v}"
              TAGS="${IMAGE_NAME}:${VERSION},${IMAGE_NAME}:latest"
            else
              # Service-specific tag (e.g., user-service-v1.0.0)
              VERSION=$(echo "$TAG" | sed 's/.*-v//')
              TAGS="${IMAGE_NAME}:${VERSION},${IMAGE_NAME}:latest"
            fi
            ENVIRONMENT="production"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual dispatch
            SHORT_SHA=$(git rev-parse --short HEAD)
            TAGS="${IMAGE_NAME}:${SHORT_SHA},${IMAGE_NAME}:latest"
            VERSION="${SHORT_SHA}"
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          else
            # Push to main branch
            SHORT_SHA=$(git rev-parse --short HEAD)
            TAGS="${IMAGE_NAME}:${SHORT_SHA},${IMAGE_NAME}:latest"
            VERSION="${SHORT_SHA}"
            ENVIRONMENT="staging"
          fi
          
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=pulse-${{ matrix.service }}
            org.opencontainers.image.description=Pulse Microservices - ${{ matrix.service }}
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
      
      - name: Deployment summary
        run: |
          echo "âœ… ${{ matrix.service }} deployed successfully"
          echo "ðŸ“¦ Image: ${{ steps.meta.outputs.image_name }}"
          echo "ðŸ·ï¸  Tags: ${{ steps.meta.outputs.tags }}"
          echo "ðŸŒ Environment: ${{ steps.meta.outputs.environment }}"

  # ============================================================================
  # STAGE 4: SUMMARY - Unified summary for PRs and Deployments
  # ============================================================================
  
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [detect-changes, build, test, deploy]
    
    steps:
      # PR Comment Summary
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ needs.build.result }}';
            const testStatus = '${{ needs.test.result }}';
            const changedServices = JSON.parse('${{ needs.detect-changes.outputs.services }}');
            
            const statusEmoji = {
              'success': 'âœ…',
              'failure': 'âŒ',
              'cancelled': 'âš ï¸',
              'skipped': 'â­ï¸'
            };
            
            // Build services list
            const servicesList = changedServices.map(s => `- ðŸ“¦ ${s}`).join('\n            ');
            
            const body = `## ðŸš€ Microservices Pipeline Results
            
            ### Pipeline Stages
            ${statusEmoji[buildStatus] || 'â“'} **Build**: ${buildStatus}
            ${statusEmoji[testStatus] || 'â“'} **Test**: ${testStatus}
            
            ### Services Processed (${changedServices.length} changed)
            ${servicesList}
            
            ${buildStatus === 'success' && testStatus === 'success'
              ? 'ðŸŽ‰ All checks passed! Ready to merge.' 
              : 'âš ï¸ Some checks failed. Please review the details above.'}
            
            ---
            ðŸ’¡ **Note**: Deployment will occur automatically when merged to \`main\`
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
  
      # Deployment Summary (for pushes to main and tags)
      - name: Create deployment summary
        if: |
          github.event_name != 'pull_request' && 
          needs.deploy.result != 'skipped' &&
          (needs.deploy.result == 'success' || needs.deploy.result == 'failure')
        run: |
          echo "# ðŸš€ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Pipeline Stages
          echo "## Pipeline Stages" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Test: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Changed Services
          CHANGED_SERVICES='${{ needs.detect-changes.outputs.services }}'
          echo "## Changed Services" >> $GITHUB_STEP_SUMMARY
          echo "$CHANGED_SERVICES" | jq -r '.[]' | while read service; do
            echo "- ðŸ”„ \`${service}\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine environment based on trigger
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            ENVIRONMENT="production"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          else
            ENVIRONMENT="staging"
          fi
          
          # Deployment Information
          echo "## Deployment Information" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "**Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ… **Status**: All services deployed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Some deployments failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployed Services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          SERVICES='${{ needs.detect-changes.outputs.services }}'
          echo "$SERVICES" | jq -r '.[]' | while read service; do
            echo "- ðŸ“¦ \`${service}\`: https://hub.docker.com/r/kal0yan/pulse-${service}" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Docker Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          
          SERVICES='${{ needs.detect-changes.outputs.services }}'
          echo "$SERVICES" | jq -r '.[]' | while read service; do
            echo "docker pull kal0yan/pulse-${service}:latest" >> $GITHUB_STEP_SUMMARY
          done
          
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      # Generic summary for other cases (non-PR, non-deployment)
      - name: Create generic summary
        if: |
          github.event_name != 'pull_request' && 
          (needs.deploy.result == 'skipped' || needs.deploy.result == 'cancelled')
        run: |
          echo "# ðŸš€ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Stages" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Test: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Changed Services
          CHANGED_SERVICES='${{ needs.detect-changes.outputs.services }}'
          echo "## Changed Services" >> $GITHUB_STEP_SUMMARY
          echo "$CHANGED_SERVICES" | jq -r '.[]' | while read service; do
            echo "- ðŸ”„ \`${service}\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "::error::Deployment failed for one or more services"
          exit 1

