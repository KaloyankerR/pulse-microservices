# Monitoring Setup Summary

## What Was Added

### 1. Docker Services
- **Prometheus** (port 9090): Metrics collection and time-series database
- **Grafana** (port 3001): Visualization and dashboarding

### 2. Configuration Files

#### Prometheus Configuration
- `config/prometheus.yml`: Scrape configuration for all microservices

#### Grafana Configuration
- `config/grafana/datasources.yml`: Auto-provision Prometheus datasource
- `config/grafana/dashboards.yml`: Dashboard provider configuration
- `config/grafana/dashboard-overview.json`: Pre-built overview dashboard

### 3. Service Updates

#### User Service (Node.js)
- Added `prom-client` dependency to `package.json`
- Created `src/config/metrics.js` with custom metrics
- Added `/metrics` endpoint to `src/app.js`
- Metrics middleware for HTTP request tracking

#### Post Service (Go)
- Added `prometheus/client_golang` to `go.mod`
- Added `/metrics` endpoint to `main.go`
- Default Prometheus metrics (CPU, memory, goroutines)

#### Existing Services (Already Had Metrics)
- ✅ Messaging Service (Go)
- ✅ Social Service (Node.js)
- ✅ Notification Service (Node.js)

### 4. Documentation
- `docs/MONITORING.md`: Comprehensive monitoring guide
- `MONITORING_QUICKSTART.md`: Quick start guide
- Updated `README.md`: Added monitoring section

## Files Created/Modified

### New Files
```
config/prometheus.yml
config/grafana/datasources.yml
config/grafana/dashboards.yml
config/grafana/dashboard-overview.json
user-service/src/config/metrics.js
docs/MONITORING.md
MONITORING_QUICKSTART.md
```

### Modified Files
```
docker-compose.yml               # Added prometheus & grafana services
user-service/src/app.js          # Added metrics endpoint & middleware
user-service/package.json        # Added prom-client dependency
post-service/main.go             # Added metrics endpoint
post-service/go.mod              # Added prometheus client
README.md                        # Added monitoring section
```

## How to Use

### Start Monitoring
```bash
docker-compose up -d prometheus grafana
```

### Access UIs
- Grafana: http://localhost:3001 (admin/admin)
- Prometheus: http://localhost:9090

### View Metrics
```bash
# Check all service endpoints
curl http://localhost:8081/metrics  # User Service
curl http://localhost:8082/metrics  # Post Service
curl http://localhost:8084/metrics  # Messaging Service
curl http://localhost:8085/metrics  # Social Service
curl http://localhost:8086/metrics  # Notification Service
```

### Verify Prometheus Targets
```bash
curl http://localhost:9090/api/v1/targets
```

## Next Steps (Optional Enhancements)

1. **Add Alerting**: Configure Alertmanager for critical alerts
2. **Add Exporters**: MongoDB, Redis, RabbitMQ exporters for infrastructure metrics
3. **Custom Dashboards**: Create service-specific dashboards
4. **Business Metrics**: Add custom metrics for KPIs (signups, posts, etc.)
5. **Distributed Tracing**: Integrate Jaeger for request tracing
6. **Log Aggregation**: Add ELK stack or Loki for centralized logging

## Troubleshooting

### If services don't start:
```bash
docker-compose down
docker-compose up -d
docker logs prometheus
docker logs grafana
```

### If metrics aren't showing:
1. Check Prometheus targets: http://localhost:9090/targets
2. Verify service health: `docker ps`
3. Check network: `docker network inspect pulse-network`
4. Test metrics endpoint: `curl http://localhost:8081/metrics`

### If you need to reset:
```bash
docker-compose down -v
docker volume rm pulse-microservices_prometheus_data
docker volume rm pulse-microservices_grafana_data
docker-compose up -d
```

## Dependencies to Install

For Node.js services that didn't have it:
```bash
cd user-service
npm install prom-client@^15.1.0
```

For Go services:
```bash
cd post-service
go mod tidy
```

## Architecture Overview

```
┌─────────────────────────────────────────────┐
│           Grafana (Visualization)           │
│            http://localhost:3001            │
└────────────────┬────────────────────────────┘
                 │
                 │ Query Metrics
                 │
┌────────────────▼────────────────────────────┐
│        Prometheus (Metrics Storage)         │
│            http://localhost:9090            │
└────────┬───┬───┬───┬───┬───────────────────┘
         │   │   │   │   │
    Scrape Metrics Every 10-15s
         │   │   │   │   │
┌────────▼───▼───▼───▼───▼────────────────────┐
│  User  │ Post │ Msg │Social│ Notification   │
│ :8081  │:8082 │:8084│:8085 │     :8086      │
│/metrics│/metrics│/metrics│/metrics│/metrics │
└─────────────────────────────────────────────┘
```

## Metrics Available

### Standard Metrics (All Services)
- HTTP request count & duration
- CPU usage
- Memory usage
- Process info (uptime, file descriptors)

### Custom Metrics

#### User Service
- `authentication_attempts_total`
- `user_operations_total`
- `database_operation_duration_seconds`

#### Notification Service
- `notifications_total`
- `notification_processing_duration_seconds`
- `events_processed_total`
- `queue_size`

#### Social Service
- `follow_operations_total`
- `block_operations_total`

#### Messaging Service
- `websocket_connections_total`
- `messages_total`
- `conversations_total`

## Success Criteria

✅ Prometheus is running and scraping all services
✅ Grafana shows the overview dashboard with data
✅ All 5 microservices expose `/metrics` endpoint
✅ HTTP metrics are being collected
✅ Custom business metrics are being tracked
✅ Dashboard auto-refreshes with real-time data

## Notes

- This is an **initial simple setup** - no complex alerting or exporters
- Retention: 15 days (configurable)
- Scrape interval: 10-15s (adjustable per service)
- No authentication on Prometheus (add for production)
- Grafana password should be changed in production
- All data stored in Docker volumes

